<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trade digitalisation benefits calculator</title>

  <!-- Same external libraries used by RiskMap's embedded app: D3 + topojson (loaded lazily inside the map component) -->
  <style>
    body { margin: 0; background: transparent; }
    #app { padding: 0; }
    .mobile-view #app { padding: 0; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // Minimal performance tracker compatible with RiskMap's embed scaffolding.
    window.hrddPerformance = window.hrddPerformance || {
      marks: {},
      measures: [],
      mark(name) { this.marks[name] = performance.now(); },
      measure(name, startMark, endMark) {
        const start = this.marks[startMark];
        const end = this.marks[endMark] ?? performance.now();
        if (typeof start === 'number') this.measures.push({ name, duration: end - start });
      }
    };

    function optimizeForMobile() {
      if (window.innerWidth <= 768) document.body.classList.add('mobile-view');
    }
    optimizeForMobile();
    window.addEventListener('resize', optimizeForMobile);
  </script>

  <script type="module">
    try {
      window.hrddPerformance.mark('script-start');

      // Mirror RiskMap's module-loader logic so Wix/iframes can import local or production paths.
      const APP_CONTROLLER_PATH = '/components/TradeAppController.js';
      const PRODUCTION_ORIGIN = window.location.origin; // set to your hosted origin if you deploy separately

      const uniqueUrls = (urls) => Array.from(
        new Set(
          urls
            .flat()
            .map((url) => {
              if (!url) return null;
              try { return new URL(url, window.location.href).href; }
              catch (error) { console.warn('Skipping invalid AppController candidate URL', url, error); return null; }
            })
            .filter(Boolean)
        )
      );

      const APP_CONTROLLER_CANDIDATES = uniqueUrls([
        `${PRODUCTION_ORIGIN}${APP_CONTROLLER_PATH}`,
        `${PRODUCTION_ORIGIN}/public${APP_CONTROLLER_PATH}`,
        `${window.location.origin}${APP_CONTROLLER_PATH}`,
        `${window.location.origin}/public${APP_CONTROLLER_PATH}`,
        APP_CONTROLLER_PATH,
        `/public${APP_CONTROLLER_PATH}`
      ]);

      const RELATIVE_IMPORT_REGEX = /(from\s+['"])(\.\.?\/[^'"\)]+)(['"])/g;
      const RELATIVE_DYNAMIC_IMPORT_REGEX = /(import\s*\(\s*['"])(\.\.?\/[^'"\)]+)(['"]\s*\))/g;
      const RELATIVE_EXPORT_REGEX = /(export\s+\*\s+from\s+['"])(\.\.?\/[^'"\)]+)(['"])/g;

      const rewriteRelativeSpecifiers = (source, baseUrl) => {
        const toAbsolute = (specifier) => new URL(specifier, baseUrl).href;
        return source
          .replace(RELATIVE_IMPORT_REGEX, (match, start, specifier, end) => `${start}${toAbsolute(specifier)}${end}`)
          .replace(RELATIVE_DYNAMIC_IMPORT_REGEX, (match, start, specifier, end) => `${start}${toAbsolute(specifier)}${end}`)
          .replace(RELATIVE_EXPORT_REGEX, (match, start, specifier, end) => `${start}${toAbsolute(specifier)}${end}`);
      };

      const importViaBlob = async (url) => {
        const response = await fetch(url, { credentials: 'omit', mode: 'cors' });
        if (!response.ok) throw new Error(`Failed to fetch ${url}: ${response.status} ${response.statusText}`);
        const source = await response.text();
        const rewritten = rewriteRelativeSpecifiers(source, url);
        const blobUrl = URL.createObjectURL(new Blob([rewritten], { type: 'text/javascript' }));
        try { return await import(blobUrl); }
        finally { URL.revokeObjectURL(blobUrl); }
      };

      const loadAppControllerModule = async () => {
        const attempts = [];
        for (const url of APP_CONTROLLER_CANDIDATES) {
          try {
            const module = await import(url);
            console.log('Loaded TradeAppController directly from', url);
            return module;
          } catch (error) {
            attempts.push(`${url} (direct import): ${error?.message || error}`);
            console.warn('Direct module import failed for', url, error);
          }
        }

        for (const url of APP_CONTROLLER_CANDIDATES) {
          try {
            const module = await importViaBlob(url);
            console.log('Loaded TradeAppController via fetch from', url);
            return module;
          } catch (error) {
            attempts.push(`${url} (fetch fallback): ${error?.message || error}`);
            console.warn('Blob import fallback failed for', url, error);
          }
        }

        throw new Error(`Unable to load TradeAppController module. Attempts: ${attempts.join(' | ')}`);
      };

      const module = await loadAppControllerModule();
      const TradeAppController = module.TradeAppController || module.default;
      if (!TradeAppController) throw new Error('TradeAppController export not found');

      window.hrddPerformance.mark('components-loaded');

      const app = new TradeAppController();
      window.tradeApp = app;

      const initializeApp = async () => {
        window.hrddPerformance.mark('init-start');
        const hasState = app.loadSavedState?.();
        if (hasState) console.log('Loaded saved state from localStorage');
        await app.initialize('app');
        window.hrddPerformance.mark('init-complete');
        window.hrddPerformance.measure('Total Initialization', 'script-start', 'init-complete');
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp, { once: true });
      } else {
        initializeApp();
      }

    } catch (error) {
      console.error('Trade digitalisation calculator failed to load:', error);
      const el = document.getElementById('app');
      if (el) {
        el.innerHTML = `<div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; padding:16px; border:1px solid #fecaca; background:#fef2f2; border-radius:12px; color:#991b1b;">Failed to load: ${error.message}</div>`;
      }
    }
  </script>
</body>
</html>
